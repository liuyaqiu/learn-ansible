# ============================================================================
# Site Playbook - Main orchestration for all environments
# ============================================================================
# This is the main entry point for VM management operations
#
# Usage Examples:
#   # Create/ensure VM is present and running
#   ansible-playbook -i inventories/dev site.yml
#
#   # Remove VM completely
#   ansible-playbook -i inventories/dev site.yml -e "vm_lifecycle_state=absent"
#
#   # Just get VM information
#   ansible-playbook -i inventories/dev site.yml --tags info
# ============================================================================

- name: VM Lifecycle Management
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Default lifecycle state - can be overridden via -e
    vm_lifecycle_state: "{{ vm_state | default('present') }}"

  pre_tasks:
    - name: Display execution context
      ansible.builtin.debug:
        msg: |
          🎯 VM Lifecycle Management Starting
          📋 Environment: {{ group_names | default(['default']) | join(', ') }}
          🔄 Target State: {{ vm_lifecycle_state }}
          🖥️  Target Host: {{ inventory_hostname }}
          👤 User: {{ ansible_user | default(ansible_user_id) }}

  roles:
    - role: kvm-vm
      vars:
        kvm_vm_state: "{{ vm_lifecycle_state }}"
        # Map global variables to role variables
        kvm_vm_name: "{{ vm_name }}"
        kvm_vm_memory: "{{ vm_memory }}"
        kvm_vm_vcpus: "{{ vm_vcpus }}"
        kvm_vm_disk_size: "{{ vm_disk_size }}"
        kvm_vm_static_ip: "{{ vm_static_ip }}"
        kvm_vm_packages: "{{ vm_packages }}"
        kvm_ssh_key_path: "{{ ssh_key_path }}"
        kvm_ssh_private_key_path: "{{ ssh_private_key_path }}"
        kvm_cloud_init_user: "{{ cloud_init_user }}"
        kvm_cloud_init_password: "{{ cloud_init_password }}"
        kvm_confirm_cleanup: "{{ confirm_cleanup }}"
        kvm_wait_for_ssh_timeout: "{{ wait_for_ssh_timeout }}"
        kvm_cloud_init_check_retries: "{{ cloud_init_check_retries }}"
        kvm_cloud_init_check_delay: "{{ cloud_init_check_delay }}"
        kvm_image_dir: "{{ image_dir }}"
        kvm_cloud_img_url: "{{ cloud_img_url }}"
        kvm_cloud_img_base_name: "{{ cloud_img_base_name }}"
        kvm_force_recreate: false
        kvm_skip_cloud_init_wait: false

  post_tasks:
    - name: Display operation summary
      ansible.builtin.debug:
        msg: |
          ✅ VM Lifecycle Management Complete!
          🎯 State: {{ vm_lifecycle_state }}
          🖥️  VM: {{ vm_name }}
          📍 Environment: {{ group_names | default(['default']) | join(', ') }}
