---
# ============================================================================
# Configuration Validation Playbook
# ============================================================================
# This playbook validates the configuration before VM operations
# 
# Usage:
#   ansible-playbook -i inventories/dev playbooks/validate-config.yml
# ============================================================================

- name: Validate VM Configuration
  hosts: localhost
  connection: local
  gather_facts: yes

  pre_tasks:
    - name: Display validation context
      debug:
        msg: |
          ğŸ” Configuration Validation Starting
          ğŸ“‹ Environment: {{ group_names | default(['default']) | join(', ') }}
          ğŸ¯ Inventory: {{ inventory_file | default('default') }}

  tasks:
    - name: Display current configuration summary
      debug:
        msg: |
          ğŸ” Configuration Summary
          ========================
          
          ğŸ“‹ Environment: {{ group_names | default(['default']) | join(', ') }}
          ğŸ–¥ï¸  VM Name: {{ vm_name }}
          ğŸ’¾ Memory: {{ vm_memory }} MB
          ğŸ”§ vCPUs: {{ vm_vcpus }}
          ğŸ’½ Disk Size: {{ vm_disk_size }} GB
          ğŸŒ Static IP: {{ vm_static_ip }}
          ğŸ”‘ SSH Key: {{ ssh_key_path }}
          ğŸ‘¤ User: {{ cloud_init_user }}
          ğŸ“¦ Packages: {{ vm_packages | length }} packages
          
          ğŸ“ File Paths (computed):
          - VM Disk: {{ image_dir }}/{{ vm_name }}.qcow2
          - Cloud Image: {{ image_dir }}/{{ cloud_img_base_name }}
          - Seed Image: {{ image_dir }}/{{ vm_name }}-seed.img

    - name: Include role validation
      include_role:
        name: kvm-vm
        tasks_from: validate.yml
      vars:
        kvm_vm_name: "{{ vm_name }}"
        kvm_vm_memory: "{{ vm_memory }}"
        kvm_vm_vcpus: "{{ vm_vcpus }}"
        kvm_vm_disk_size: "{{ vm_disk_size }}"
        kvm_vm_static_ip: "{{ vm_static_ip }}"
        kvm_ssh_key_path: "{{ ssh_key_path }}"
        kvm_ssh_private_key_path: "{{ ssh_private_key_path }}"
        kvm_cloud_init_user: "{{ cloud_init_user }}"

    - name: Check for potential IP conflicts
      shell: |
        if ping -c 1 -W 1 {{ vm_static_ip }} >/dev/null 2>&1; then
          echo "IP_IN_USE"
        else
          echo "IP_AVAILABLE"
        fi
      register: ip_check
      changed_when: false
      failed_when: false

    - name: Report IP availability
      debug:
        msg: |
          {% if ip_check.stdout == "IP_IN_USE" %}
          âš ï¸  WARNING: IP {{ vm_static_ip }} appears to be in use
          {% else %}
          âœ… IP {{ vm_static_ip }} appears to be available
          {% endif %}

    - name: Validate image directory permissions
      stat:
        path: "{{ image_dir }}"
      register: image_dir_stat

    - name: Check image directory accessibility
      assert:
        that:
          - image_dir_stat.stat.exists
          - image_dir_stat.stat.isdir
        fail_msg: "âŒ Image directory is not accessible: {{ image_dir }}"
        success_msg: "âœ… Image directory is accessible"

  post_tasks:
    - name: Display validation results
      debug:
        msg: |
          âœ… Configuration Validation Complete!
          
          ğŸ“Š Summary:
          - All required variables: âœ… Valid
          - Resource constraints: âœ… Within limits  
          - IP address format: âœ… Valid
          - SSH key: âœ… Accessible
          - Package list: âœ… Configured
          - Image directory: âœ… Accessible
          
          ğŸš€ Configuration is ready for deployment!
          
          ğŸ’¡ Next Steps:
          - Run: ansible-playbook -i inventories/{{ group_names[0] | default('dev') }} playbooks/site.yml
          - Or create VM: ansible-playbook -i inventories/{{ group_names[0] | default('dev') }} playbooks/vm-create.yml
