# ============================================================================
# VM Destruction Playbook - Focused on removing VMs
# ============================================================================
# This playbook specifically handles VM cleanup and removal
#
# Usage:
#   ansible-playbook -i inventories/dev playbooks/vm-destroy.yml
# ============================================================================

- name: Destroy and Clean Up KVM Virtual Machine
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    # Force VM state to absent for this playbook
    vm_lifecycle_state: absent

  pre_tasks:
    - name: Display destruction warning
      ansible.builtin.debug:
        msg: |
          ‚ö†Ô∏è  VM DESTRUCTION WARNING ‚ö†Ô∏è

          üéØ Target VM: {{ vm_name }}
          üìç Environment: {{ group_names | default(['default']) | join(', ') }}
          üóëÔ∏è  Action: Complete removal of VM and associated files

          This operation will:
          - Stop and destroy the VM if running
          - Remove VM definition from libvirt
          - Delete VM disk and cloud-init files
          - Preserve the base cloud image for reuse

    - name: Safety pause for confirmation
      ansible.builtin.pause:
        prompt: |
          ‚ö†Ô∏è  WARNING: About to destroy VM '{{ vm_name }}'!

          This action cannot be undone. All VM data will be lost.

          Press Enter to continue or Ctrl+C to abort.
      when: confirm_cleanup | default(true)

  roles:
    - role: kvm-vm
      vars:
        kvm_vm_state: "{{ vm_lifecycle_state }}"
        kvm_vm_name: "{{ vm_name }}"
        kvm_vm_memory: "{{ vm_memory }}"
        kvm_vm_vcpus: "{{ vm_vcpus }}"
        kvm_vm_disk_size: "{{ vm_disk_size }}"
        kvm_vm_static_ip: "{{ vm_static_ip }}"
        kvm_ssh_key_path: "{{ ssh_key_path }}"
        kvm_ssh_private_key_path: "{{ ssh_private_key_path }}"
        kvm_cloud_init_user: "{{ cloud_init_user }}"
        kvm_cloud_init_password: "{{ cloud_init_password }}"
        kvm_confirm_cleanup: "{{ confirm_cleanup | default(false) }}"
        kvm_image_dir: "{{ image_dir }}"
        kvm_cloud_img_base_name: "{{ cloud_img_base_name }}"

  post_tasks:
    - name: Verify VM removal
      ansible.builtin.command: virsh list --all --name
      register: remaining_vms
      changed_when: false
      become: true

    - name: Display destruction summary
      ansible.builtin.debug:
        msg: |
          ‚úÖ VM Destruction Complete!
          üóëÔ∏è  VM '{{ vm_name }}' has been removed
          üìä Remaining VMs: {{ (remaining_vms.stdout_lines | default([])) | length }}

          üîÑ Next Steps:
          - Use vm-create.yml to recreate if needed
          - Base cloud image preserved for future use
          - Use 'virsh list --all' to verify removal
