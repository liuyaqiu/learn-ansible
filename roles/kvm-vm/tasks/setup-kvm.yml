# ============================================================================
# KVM VM Role - KVM/Libvirt Setup Tasks
# ============================================================================

- name: Install KVM/libvirt and cloud-utils dependencies
  ansible.builtin.package:
    name: "{{ _kvm_required_packages[ansible_os_family] }}"
    state: present
    update_cache: true
  become: true

- name: Ensure libvirtd service is running and enabled
  ansible.builtin.service:
    name: libvirtd
    state: started
    enabled: true
  become: true

- name: Ensure default libvirt network is active and autostarted
  community.libvirt.virt_net:
    name: default
    state: active
    autostart: true
  become: true

- name: Get default network information
  community.libvirt.virt_net:
    name: default
    command: info
  register: _kvm_default_network_info
  become: true

- name: Get virbr0 IP address for gateway
  ansible.builtin.shell: |
    set -o pipefail
    ip addr show virbr0 | grep 'inet ' | awk '{print $2}' | cut -d'/' -f1
  register: _kvm_virbr0_ip_result
  changed_when: false

- name: Set virbr0 gateway IP variable
  ansible.builtin.set_fact:
    _kvm_virbr0_gateway_ip: "{{ _kvm_virbr0_ip_result.stdout }}"

- name: Verify network connectivity
  ansible.builtin.command: ping -c 1 -W 2 {{ _kvm_virbr0_gateway_ip }}
  register: _kvm_network_ping
  changed_when: false
  failed_when: _kvm_network_ping.rc != 0

- name: Display network information
  ansible.builtin.debug:
    msg: |
      âœ… Libvirt default network is active and configured
      ğŸŒ Gateway IP: {{ _kvm_virbr0_gateway_ip }}
      ğŸ“¡ Network state: {{ _kvm_default_network_info.networks.default.state }}
      ğŸ”§ Autostart: {{ _kvm_default_network_info.networks.default.autostart }}
      ğŸŒ‰ Bridge: {{ _kvm_default_network_info.networks.default.bridge }}
      ğŸ“ Connectivity test: {{ 'PASSED' if _kvm_network_ping.rc == 0 else 'FAILED' }}

- name: Add current user to libvirt group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: libvirt
    append: true
  become: true
  changed_when: false
  failed_when: false
